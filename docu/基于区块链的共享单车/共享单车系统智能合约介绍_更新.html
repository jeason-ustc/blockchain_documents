<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>共享单车系统智能合约介绍</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="kkux" id="共享单车系统智能合约介绍">共享单车系统智能合约介绍</h1><hr><p data-anchor-id="3noc">共享单车系统主要包括系统合约和用户合约，下面将详细的分别介绍这两个合约：</p><blockquote data-anchor-id="mrf8" class="white-blockquote">
  <ul>
  <li>用户合约</li>
  <li>系统合约</li>
  </ul>
</blockquote><hr><div class="md-section-divider"></div><h2 data-anchor-id="62s4" id="用户合约">用户合约</h2><p data-anchor-id="nrop">用户合约是区块链上单车的一种存在形态，赋予及体现了单车所拥有的一些属性，如单车的所有者，租赁情况，买卖情况，地处坐标以及相对于相对于初始距离的一些状态指示位，下面就是本次demo演示的用户合约代码，后续在此基础上用户可以添加其他属性来对单车增添更多的状态以及更为丰富的承载体，做到了灵活多变。</p><div class="md-section-divider"></div><h3 data-anchor-id="th04" id="1-用户合约代码">1. 用户合约代码</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="131a"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">contract user_bicycle_info </span><span class="pun">{</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com">#区块链上单车的属性，用户可以根据需求灵活添加更多属性</span></code></li><li class="L3"><code class="language-python"><span class="pln">    address owner_addr</span><span class="pun">;</span><span class="pln">      </span><span class="com">#拥有者</span></code></li><li class="L4"><code class="language-python"><span class="pln">    uint public  rent_flag</span><span class="pun">;</span><span class="pln">  </span><span class="com">#租赁属性</span></code></li><li class="L5"><code class="language-python"><span class="pln">    uint public  rent_value</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">    uint public  sell_flag</span><span class="pun">;</span><span class="pln">  </span><span class="com">#买卖属性</span></code></li><li class="L7"><code class="language-python"><span class="pln">    uint public  sell_value</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">    uint public origin_distance</span><span class="pun">;</span><span class="pln">  </span><span class="com">#位置属性</span></code></li><li class="L9"><code class="language-python"><span class="pln">    uint public update_distance</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">    uint public out_of_bound</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">    uint public reward_value</span><span class="pun">;</span><span class="pln">  </span><span class="com">#奖励属性</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">   function user_bicycle_info </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L4"><code class="language-python"><span class="pln">   owner_addr </span><span class="pun">=</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">   rent_value </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">   rent_flag </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">   sell_flag </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">   sell_value </span><span class="pun">=</span><span class="pln"> </span><span class="lit">300</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">   origin_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">   update_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">   out_of_bound </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">   reward_value </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L5"><code class="language-python"><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="huq5" id="系统管理合约">系统管理合约</h2><p data-anchor-id="gyvn">系统合约是对区块链该系统上所有单车的一个智能管理，包括用户注册单车，租赁单车、还车，两方交易单车以及奖励系统。用户需要将自己已发布的用户合约地址注册到该系统上并同时缴纳一定的押金，系统也会将该地址以列表的形式展示给其他用户供其租赁或者直接买卖交易，采用提前约定规则的方式来对用户以及用户合约进行系统管理。下面是系统合约的代码及部分注解。</p><div class="md-section-divider"></div><h3 data-anchor-id="2pv3" id="1-系统合约代码">1. 系统合约代码</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="gkxf"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">pragma solidity </span><span class="pun">^</span><span class="lit">0.4</span><span class="pun">.</span><span class="lit">4</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">contract system_manage </span><span class="pun">{</span></code></li><li class="L3"><code class="language-python"><span class="pln">   address public organizer</span><span class="pun">;</span><span class="pln">  </span><span class="com">#系统管理者（即系统合约发布者） </span></code></li><li class="L4"><code class="language-python"><span class="pln">   uint public user_amount</span><span class="pun">;</span><span class="pln">   </span><span class="com">#系统用户数</span></code></li><li class="L5"><code class="language-python"><span class="pln">   uint public deposit_quota</span><span class="pun">;</span><span class="pln"> </span><span class="com">#押金</span></code></li><li class="L6"><code class="language-python"><span class="pln">   uint public balance</span><span class="pun">;</span><span class="pln">       </span></code></li><li class="L7"><code class="language-python"><span class="pln">   address</span><span class="pun">[]</span><span class="pln"> public user_list</span><span class="pun">;</span><span class="pln">    </span><span class="com">#用户列表 </span></code></li><li class="L8"><code class="language-python"><span class="pln">   address</span><span class="pun">[]</span><span class="pln"> public user_contract_list</span><span class="pun">;</span><span class="pln"> </span><span class="com">#用户合约列表</span></code></li><li class="L9"><code class="language-python"><span class="pln">   address</span><span class="pun">[]</span><span class="pln"> public used_contract_list</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">   address</span><span class="pun">[]</span><span class="pln"> public far_contract_list</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">   mapping </span><span class="pun">(</span><span class="pln">address </span><span class="pun">=&gt;</span><span class="pln"> uint</span><span class="pun">)</span><span class="pln"> public balances</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">   struct </span><span class="typ">Bicycle_info</span><span class="pun">{</span></code></li><li class="L4"><code class="language-python"><span class="pln">        address owner_addr</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">        uint rent</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">        uint rent_value</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">        uint sell</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">        uint sell_value</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">        uint origin_distance</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">        uint update_distance</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">        uint out_of_bound</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">        uint reward_value</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">   mapping </span><span class="pun">(</span><span class="pln">address </span><span class="pun">=&gt;</span><span class="pln"> uint</span><span class="pun">)</span><span class="pln"> public registrantsPaid</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L6"><code class="language-python"><span class="pln">   mapping </span><span class="pun">(</span><span class="pln">address </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="typ">Bicycle_info</span><span class="pun">)</span><span class="pln"> public depository</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L7"><code class="language-python"><span class="pln">   mapping </span><span class="pun">(</span><span class="pln">address </span><span class="pun">=&gt;</span><span class="pln"> address</span><span class="pun">)</span><span class="pln"> public rent_info_map</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L8"><code class="language-python"><span class="pln">   mapping </span><span class="pun">(</span><span class="pln">address </span><span class="pun">=&gt;</span><span class="pln"> address</span><span class="pun">)</span><span class="pln"> public sell_info_map</span><span class="pun">;</span><span class="pln">   </span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">   event </span><span class="typ">Deposit</span><span class="pun">(</span><span class="pln">address _from</span><span class="pun">,</span><span class="pln"> uint _user_amount</span><span class="pun">);</span><span class="pln">  </span><span class="com">#用于日志记录</span></code></li><li class="L1"><code class="language-python"><span class="pln">   event </span><span class="typ">Refund</span><span class="pun">(</span><span class="pln">address _to</span><span class="pun">,</span><span class="pln"> uint _user_amount</span><span class="pun">);</span><span class="pln">    </span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">   function system_manage</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L4"><code class="language-python"><span class="pln">   organizer </span><span class="pun">=</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">   user_amount </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">   deposit_quota </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">  </span><span class="com">#改变系统押金数</span></code></li><li class="L0"><code class="language-python"><span class="pln">  function changeQuota</span><span class="pun">(</span><span class="pln">uint newquota</span><span class="pun">)</span><span class="pln"> public </span><span class="pun">{</span><span class="pln">   </span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender </span><span class="pun">!=</span><span class="pln"> organizer</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"><span class="pln">    deposit_quota </span><span class="pun">=</span><span class="pln"> newquota</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">   </span><span class="com">#用户充值函数                                          </span></code></li><li class="L8"><code class="language-python"><span class="pln">  function charge</span><span class="pun">()</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">){</span><span class="pln">  </span></code></li><li class="L9"><code class="language-python"><span class="pln">     balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100000</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">     </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">   </span><span class="com">#注册函数</span></code></li><li class="L4"><code class="language-python"><span class="pln">  function register</span><span class="pun">(</span><span class="pln">address contract_address</span><span class="pun">,</span><span class="pln">uint user_deposit_amount</span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln">  </span><span class="pun">{</span><span class="pln">       </span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">user_deposit_amount </span><span class="pun">!=</span><span class="pln"> deposit_quota</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-python"><span class="pln">    registrantsPaid</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_deposit_amount</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">owner_addr </span><span class="pun">=</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">rent </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">rent_value </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">origin_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">out_of_bound </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L4"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">update_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_address</span><span class="pun">].</span><span class="pln">reward_value </span><span class="pun">=</span><span class="pln"> </span><span class="lit">50</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">    user_amount</span><span class="pun">++;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]-=</span><span class="pln">deposit_quota</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">    own_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">contract_address</span><span class="pun">);</span></code></li><li class="L9"><code class="language-python"><span class="pln">    user_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">);</span></code></li><li class="L0"><code class="language-python"><span class="pln">    user_contract_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">contract_address</span><span class="pun">);</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="typ">Deposit</span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">,</span><span class="pln"> user_deposit_amount</span><span class="pun">);</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln"> </span><span class="com">#购买函数</span></code></li><li class="L6"><code class="language-python"><span class="pln">  function buy</span><span class="pun">(</span><span class="pln">address contract_addr</span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">rent </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-python"><span class="pln">         </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">sell_value</span><span class="pun">)){</span></code></li><li class="L1"><code class="language-python"><span class="pln">        throw</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">sell</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L4"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">=</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">    sell_info_map</span><span class="pun">[</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">]=</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">    balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]-=</span><span class="lit">300</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">  </span><span class="com">#还车函数</span></code></li><li class="L1"><code class="language-python"><span class="pln">  function refund</span><span class="pun">(</span><span class="pln">address contract_addr</span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">rent_info_map</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">rent </span><span class="pun">!=</span><span class="lit">1</span><span class="pln"> </span><span class="pun">){</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">rent</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">update_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">update_distance</span><span class="pun">-</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">origin_distance</span><span class="pun">&gt;</span><span class="lit">800</span><span class="pun">){</span></code></li><li class="L1"><code class="language-python"><span class="pln">         far_contract_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">contract_addr</span><span class="pun">);</span></code></li><li class="L2"><code class="language-python"><span class="pln">         depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">out_of_bound </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">deposit_quota</span><span class="pun">)){</span></code></li><li class="L5"><code class="language-python"><span class="pln">        throw</span><span class="pun">;</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code class="language-python"><span class="pln">    registrantsPaid</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">    balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]-=</span><span class="lit">100</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">    user_amount</span><span class="pun">--;</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="typ">Refund</span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">,</span><span class="pln"> user_amount</span><span class="pun">);</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">  </span><span class="com">#租赁函数</span></code></li><li class="L5"><code class="language-python"><span class="pln">  function rent</span><span class="pun">(</span><span class="pln">address select_contract_address</span><span class="pun">,</span><span class="pln">uint rent_value </span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-python"><span class="pln">     </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">rent </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-python"><span class="pln">         </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L9"><code class="language-python"><span class="pln">     </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">rent_value </span><span class="pun">!=</span><span class="pln"> depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">rent_value</span><span class="pun">){</span></code></li><li class="L0"><code class="language-python"><span class="pln">         </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L2"><code class="language-python"><span class="pln">     registrantsPaid</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> deposit_quota</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">     </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">rent_value</span><span class="pun">)){</span></code></li><li class="L4"><code class="language-python"><span class="pln">         throw</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L6"><code class="language-python"><span class="pln">     rent_info_map</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]=</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">     user_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">);</span></code></li><li class="L8"><code class="language-python"><span class="pln">     used_contract_list</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">select_contract_address</span><span class="pun">);</span></code></li><li class="L9"><code class="language-python"><span class="pln">     user_amount</span><span class="pun">++;</span></code></li><li class="L0"><code class="language-python"><span class="pln">     depository</span><span class="pun">[</span><span class="pln">select_contract_address</span><span class="pun">].</span><span class="pln">rent</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L1"><code class="language-python"><span class="pln">     balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]-=</span><span class="pln">deposit_quota</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">     </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="com">#退押金函数</span></code></li><li class="L6"><code class="language-python"><span class="pln">  function withdraw</span><span class="pun">(</span><span class="pln">address contract_addr</span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">rent </span><span class="pun">==</span><span class="lit">1</span><span class="pln"> </span><span class="pun">){</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender </span><span class="pun">!=</span><span class="pln"> depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">owner_addr</span><span class="pun">){</span></code></li><li class="L1"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">deposit_quota</span><span class="pun">)){</span></code></li><li class="L4"><code class="language-python"><span class="pln">        throw</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code class="language-python"><span class="pln">    balances</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+=</span><span class="pln">deposit_quota</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    registrantsPaid</span><span class="pun">[</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L8"><code class="language-python"><span class="pln">    user_amount</span><span class="pun">--;</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">  </span><span class="com">#奖励函数</span></code></li><li class="L4"><code class="language-python"><span class="pln">  function reward</span><span class="pun">(</span><span class="pln">address contract_addr</span><span class="pun">)</span><span class="pln"> public returns </span><span class="pun">(</span><span class="pln">bool success</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">out_of_bound </span><span class="pun">!=</span><span class="lit">1</span><span class="pln"> </span><span class="pun">){</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> false</span><span class="pun">;</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">reward_value</span><span class="pun">)){</span></code></li><li class="L9"><code class="language-python"><span class="pln">        throw</span><span class="pun">;</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">update_distance </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L2"><code class="language-python"><span class="pln">    depository</span><span class="pun">[</span><span class="pln">contract_addr</span><span class="pun">].</span><span class="pln">out_of_bound </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> true</span><span class="pun">;</span></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="pun">}</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="com">#系统合约销毁功能</span></code></li><li class="L8"><code class="language-python"><span class="pln">  function destroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">sender </span><span class="pun">==</span><span class="pln"> organizer</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L0"><code class="language-python"><span class="pln">      suicide</span><span class="pun">(</span><span class="pln">organizer</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="pun">}</span><span class="pln">   </span></code></li><li class="L3"><code class="language-python"><span class="pun">}</span></code></li></ol></pre></div>
</body>
</html>